//Generated by TurboLink CodeGenerator, do not edit!
#include "SAuth/AuthNode.h"
#include "SAuth/AuthService.h"
#include "TurboLinkGrpcManager.h"
#include "TurboLinkGrpcUtilities.h"
#include "Engine/World.h"
#include "TimerManager.h"
#include "Runtime/Launch/Resources/Version.h"

UCallAuthServiceGuestLogin* UCallAuthServiceGuestLogin::GuestLogin(UObject* WorldContextObject, const FGrpcAuthGuestLoginRequest& request, FGrpcMetaData metaData, float deadLineSeconds)
{
	UCallAuthServiceGuestLogin* node = NewObject<UCallAuthServiceGuestLogin>(WorldContextObject);
	UTurboLinkGrpcManager* turboLinkManager = UTurboLinkGrpcUtilities::GetTurboLinkGrpcManager(WorldContextObject);

	node->AuthService = Cast<UAuthService>(turboLinkManager->MakeService("AuthService"));
	if (node->AuthService == nullptr)
	{
		return nullptr;
	}
	node->ServiceState = EGrpcServiceState::Idle;
	node->Request = request;
	node->MetaData = metaData;
	node->DeadLineSeconds = deadLineSeconds;

	node->AuthService->OnServiceStateChanged.AddUniqueDynamic(node, &UCallAuthServiceGuestLogin::OnServiceStateChanged);
	return node;
}

void UCallAuthServiceGuestLogin::Activate()
{
	AuthService->Connect();
}

void UCallAuthServiceGuestLogin::OnServiceStateChanged(EGrpcServiceState NewState)
{
	if (ServiceState == NewState) return;
	ServiceState = NewState;

	if (NewState == EGrpcServiceState::TransientFailure)
	{
		FGrpcResult result;
		result.Code = EGrpcResultCode::ConnectionFailed;

		FGrpcAuthLoginResponse response;
		OnFail.Broadcast(result, response);

		Shutdown();
		return;
	}

	if (NewState == EGrpcServiceState::Ready)
	{
		AuthServiceClient = AuthService->MakeClient();
		AuthServiceClient->OnContextStateChange.AddUniqueDynamic(this, &UCallAuthServiceGuestLogin::OnContextStateChange);
		AuthServiceClient->OnGuestLoginResponse.AddUniqueDynamic(this, &UCallAuthServiceGuestLogin::OnResponse);

		Context = AuthServiceClient->InitGuestLogin();
		AuthServiceClient->GuestLogin(Context, Request, MetaData, DeadLineSeconds);
	}
}

void UCallAuthServiceGuestLogin::OnContextStateChange(FGrpcContextHandle Handle, EGrpcContextState State)
{
	if (State == EGrpcContextState::Done)
	{
		Shutdown();
	}
}

void UCallAuthServiceGuestLogin::OnResponse(FGrpcContextHandle Handle, const FGrpcResult& GrpcResult, const FGrpcAuthLoginResponse& Response)
{
	if (GrpcResult.Code == EGrpcResultCode::Ok)
	{
		OnGuestLoginResponse.Broadcast(GrpcResult, Response);
	}
	else
	{
		OnFail.Broadcast(GrpcResult, Response);
	}
}

void UCallAuthServiceGuestLogin::Shutdown()
{
	AuthService->OnServiceStateChanged.RemoveDynamic(this, &UCallAuthServiceGuestLogin::OnServiceStateChanged);
	if (AuthServiceClient != nullptr)
	{
		AuthService->RemoveClient(AuthServiceClient);
		AuthServiceClient->Shutdown();
		AuthServiceClient = nullptr;
	}

	if (AuthService != nullptr)
	{
		UTurboLinkGrpcUtilities::GetTurboLinkGrpcManager(this)->ReleaseService(AuthService);
		AuthService = nullptr;
	}

	SetReadyToDestroy();
#if ENGINE_MAJOR_VERSION>=5
	MarkAsGarbage();
#else
	MarkPendingKill();
#endif
}

UCallAuthServiceValidateUserToken* UCallAuthServiceValidateUserToken::ValidateUserToken(UObject* WorldContextObject, const FGrpcAuthValidateUserTokenRequest& request, FGrpcMetaData metaData, float deadLineSeconds)
{
	UCallAuthServiceValidateUserToken* node = NewObject<UCallAuthServiceValidateUserToken>(WorldContextObject);
	UTurboLinkGrpcManager* turboLinkManager = UTurboLinkGrpcUtilities::GetTurboLinkGrpcManager(WorldContextObject);

	node->AuthService = Cast<UAuthService>(turboLinkManager->MakeService("AuthService"));
	if (node->AuthService == nullptr)
	{
		return nullptr;
	}
	node->ServiceState = EGrpcServiceState::Idle;
	node->Request = request;
	node->MetaData = metaData;
	node->DeadLineSeconds = deadLineSeconds;

	node->AuthService->OnServiceStateChanged.AddUniqueDynamic(node, &UCallAuthServiceValidateUserToken::OnServiceStateChanged);
	return node;
}

void UCallAuthServiceValidateUserToken::Activate()
{
	AuthService->Connect();
}

void UCallAuthServiceValidateUserToken::OnServiceStateChanged(EGrpcServiceState NewState)
{
	if (ServiceState == NewState) return;
	ServiceState = NewState;

	if (NewState == EGrpcServiceState::TransientFailure)
	{
		FGrpcResult result;
		result.Code = EGrpcResultCode::ConnectionFailed;

		FGrpcAuthValidateUserTokenResponse response;
		OnFail.Broadcast(result, response);

		Shutdown();
		return;
	}

	if (NewState == EGrpcServiceState::Ready)
	{
		AuthServiceClient = AuthService->MakeClient();
		AuthServiceClient->OnContextStateChange.AddUniqueDynamic(this, &UCallAuthServiceValidateUserToken::OnContextStateChange);
		AuthServiceClient->OnValidateUserTokenResponse.AddUniqueDynamic(this, &UCallAuthServiceValidateUserToken::OnResponse);

		Context = AuthServiceClient->InitValidateUserToken();
		AuthServiceClient->ValidateUserToken(Context, Request, MetaData, DeadLineSeconds);
	}
}

void UCallAuthServiceValidateUserToken::OnContextStateChange(FGrpcContextHandle Handle, EGrpcContextState State)
{
	if (State == EGrpcContextState::Done)
	{
		Shutdown();
	}
}

void UCallAuthServiceValidateUserToken::OnResponse(FGrpcContextHandle Handle, const FGrpcResult& GrpcResult, const FGrpcAuthValidateUserTokenResponse& Response)
{
	if (GrpcResult.Code == EGrpcResultCode::Ok)
	{
		OnValidateUserTokenResponse.Broadcast(GrpcResult, Response);
	}
	else
	{
		OnFail.Broadcast(GrpcResult, Response);
	}
}

void UCallAuthServiceValidateUserToken::Shutdown()
{
	AuthService->OnServiceStateChanged.RemoveDynamic(this, &UCallAuthServiceValidateUserToken::OnServiceStateChanged);
	if (AuthServiceClient != nullptr)
	{
		AuthService->RemoveClient(AuthServiceClient);
		AuthServiceClient->Shutdown();
		AuthServiceClient = nullptr;
	}

	if (AuthService != nullptr)
	{
		UTurboLinkGrpcUtilities::GetTurboLinkGrpcManager(this)->ReleaseService(AuthService);
		AuthService = nullptr;
	}

	SetReadyToDestroy();
#if ENGINE_MAJOR_VERSION>=5
	MarkAsGarbage();
#else
	MarkPendingKill();
#endif
}
